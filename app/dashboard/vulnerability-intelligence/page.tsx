'use client';

import React, { ReactNode } from "react";
import { useState, useMemo } from 'react';
import { useGetVulnerabilityIntelligences, useDeleteVulnerabilityIntelligence, useUpdateVulnerabilityIntelligence } from '@/lib/api/endpoints/vulnerability-intelligence';
import { Button } from '@/components/ui/button';
import { Pencil, ChevronDown, File } from 'lucide-react';
import { toast } from 'sonner';
import { VulnerabilityIntelligence, VulnerabilityStatus, VulnerabilitySeverity } from '@/lib/api/types';
import Link from 'next/link';
import {
  ColumnDef,
  useReactTable,
  getCoreRowModel,
  getPaginationRowModel,
  getSortedRowModel,
  SortingState,
  getFilteredRowModel,
  ColumnFiltersState,
  RowSelectionState,
  Row,
} from "@tanstack/react-table";
import { Input } from "@/components/ui/input";
import { useTableStyle } from '@/hooks/use-table-style';
import { PageContainer } from '@/components/layout/page-container';
import { Badge } from '@/components/ui/badge';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

export default function VulnerabilityIntelligencePage() {
  const { data: vulnerabilityData, isLoading, error, refetch } = useGetVulnerabilityIntelligences();
  const deleteVulnerabilityIntelligence = useDeleteVulnerabilityIntelligence();
  const updateVulnerabilityIntelligence = useUpdateVulnerabilityIntelligence();
  
  const [isDeleting, setIsDeleting] = useState(false);
  const [isUpdating, setIsUpdating] = useState(false);
  const [sorting, setSorting] = useState<SortingState>([]);
  const [columnFilters, setColumnFilters] = useState<ColumnFiltersState>([]);
  const [rowSelection, setRowSelection] = useState<RowSelectionState>({});
  const [showBulkDeleteDialog, setShowBulkDeleteDialog] = useState(false);

  const handleDelete = async (id: string) => {
    setIsDeleting(true);
    try {
      await deleteVulnerabilityIntelligence.mutateAsync(id);
      refetch();
      toast.success('Vulnerability intelligence entry deleted successfully');
    } catch (error) {
      console.error('Failed to delete vulnerability intelligence entry:', error);
      toast.error('Failed to delete vulnerability intelligence entry');
    } finally {
      setIsDeleting(false);
    }
  };

  const handleBulkDelete = async () => {
    setIsDeleting(true);
    const selectedRows = table.getFilteredSelectedRowModel().rows;
    const selectedIds = selectedRows.map(row => row.original._id);
    
    let successCount = 0;
    let errorCount = 0;
    
    try {
      for (const id of selectedIds) {
        try {
          await deleteVulnerabilityIntelligence.mutateAsync(id);
          successCount++;
        } catch (error) {
          console.error(`Failed to delete vulnerability intelligence entry ${id}:`, error);
          errorCount++;
        }
      }
      
      if (successCount > 0) {
        toast.success(`Successfully deleted ${successCount} entries${errorCount > 0 ? `, ${errorCount} failed` : ''}`);
        refetch();
      } else {
        toast.error('Failed to delete any entries');
      }
    } catch (error) {
      console.error('Bulk deletion failed:', error);
      toast.error('Bulk deletion process failed');
    } finally {
      setIsDeleting(false);
      setShowBulkDeleteDialog(false);
      setRowSelection({});
    }
  };

  const handleUpdate = (vulnerability: VulnerabilityIntelligence) => {
    window.location.href = `/dashboard/vulnerability-intelligence/${vulnerability._id}/edit`;
  };

  const handleStatusChange = async (id: string, newStatus: VulnerabilityStatus) => {
    setIsUpdating(true);
    try {
      await updateVulnerabilityIntelligence.mutateAsync({
        id,
        status: newStatus
      });
      toast.success('Status updated successfully');
      refetch();
    } catch (error) {
      console.error('Failed to update status:', error);
      toast.error('Failed to update status');
    } finally {
      setIsUpdating(false);
    }
  };

  const formatDate = (dateString?: string) => {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
  };

  const getSeverityBadge = (severity: VulnerabilitySeverity) => {
    const variants: Record<string, string> = {
      'critical': 'destructive',
      'high': 'destructive', 
      'medium': 'warning',
      'low': 'secondary'
    };
    
    const variant = variants[severity] || 'default';
    
    return (
      <Badge variant={variant as any}>{severity}</Badge>
    );
  };

  const getStatusBadge = (status: VulnerabilityStatus) => {
    const variants: Record<string, string> = {
      'investigating': 'warning',
      'resolved': 'success',
      'unresolved': 'destructive'
    };
    
    const variant = variants[status] || 'default';
    
    return (
      <Badge variant={variant as any}>{status}</Badge>
    );
  };

  const statusOptions: VulnerabilityStatus[] = [
    'investigating',
    'resolved',
    'unresolved'
  ];

  const tableStyle = useTableStyle<VulnerabilityIntelligence>({
    enableSelection: true,
    enableSorting: true,
    sortableColumns: ['vulnerabilityID', 'severity', 'status', 'vendor', 'createdAt'],
    onDelete: handleDelete,
    onBulkDelete: handleBulkDelete,
    isDeleting,
    showBulkDeleteDialog,
    setShowBulkDeleteDialog,
  });

  const columns = useMemo<ColumnDef<VulnerabilityIntelligence>[]>(
    () => [
      tableStyle.getSelectionColumn(),
      tableStyle.getDefaultColumn('vulnerabilityID', 'Vulnerability ID', {
        isSortable: true,
        cellClassName: 'font-medium',
      }),
      {
        accessorKey: 'severity',
        header: 'Severity',
        enableSorting: true,
        cell: ({ row }: { row: Row<VulnerabilityIntelligence> }) => getSeverityBadge(row.original.severity),
      },
      {
        accessorKey: 'status',
        header: 'Status',
        enableSorting: true,
        cell: ({ row }: { row: Row<VulnerabilityIntelligence> }) => (
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button 
                variant="ghost" 
                className="h-8 flex items-center gap-1 p-1 w-full justify-start"
                disabled={isUpdating}
              >
                {getStatusBadge(row.original.status)}
                <ChevronDown className="h-4 w-4 opacity-50" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="start">
              {statusOptions.map((status) => (
                <DropdownMenuItem
                  key={status}
                  className="cursor-pointer"
                  onClick={() => handleStatusChange(row.original._id, status)}
                >
                  {getStatusBadge(status)}
                </DropdownMenuItem>
              ))}
            </DropdownMenuContent>
          </DropdownMenu>
        ),
      },
      tableStyle.getDefaultColumn('vendor', 'Vendor', {
        isSortable: true,
      }),
      {
        accessorKey: 'description',
        header: 'Description',
        cell: ({ row }: { row: Row<VulnerabilityIntelligence> }) => (
          <div className="max-w-md truncate" title={row.original.description}>
            {row.original.description}
          </div>
        ),
      },
      tableStyle.getDefaultColumn('createdAt', 'Created At', {
        isSortable: true,
        formatter: formatDate,
      }),
      {
        accessorKey: 'sampleFile',
        header: 'Sample File',
        cell: ({ row }: { row: Row<VulnerabilityIntelligence> }) => {
          const url = row.original.sampleFile;
          if (!url) return <span className="text-muted-foreground text-sm">No file</span>;
          
          return (
            <a 
              href={url} 
              target="_blank" 
              rel="noopener noreferrer"
              className="text-blue-600 hover:underline text-sm flex items-center"
            >
              <File className="h-4 w-4 mr-1" />
              View File
            </a>
          );
        },
      },
      {
        accessorKey: 'references',
        header: 'References',
        cell: ({ row }: { row: Row<VulnerabilityIntelligence> }) => {
          const references = row.original.references;
          if (!references || references.length === 0) {
            return <span className="text-muted-foreground text-sm">No references</span>;
          }
          
          return (
            <div className="max-w-md">
              {references.slice(0, 2).map((ref, i) => (
                <a 
                  key={i} 
                  href={ref} 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  className="text-blue-600 hover:underline text-sm block truncate"
                >
                  {ref}
                </a>
              ))}
              {references.length > 2 && (
                <span className="text-muted-foreground text-xs">+{references.length - 2} more</span>
              )}
            </div>
          );
        },
      },
      tableStyle.getActionColumn((vulnerability: VulnerabilityIntelligence) => (
        <>
          <Button
            variant="ghost"
            size="icon"
            onClick={() => handleUpdate(vulnerability)}
            className="h-8 w-8 p-0"
          >
            <Pencil className="h-4 w-4" />
          </Button>
          <tableStyle.DeleteDialog id={vulnerability._id} />
        </>
      )),
    ],
    [isDeleting, isUpdating]
  );

  const table = useReactTable({
    data: Array.isArray(vulnerabilityData) ? vulnerabilityData : [],
    columns,
    getCoreRowModel: getCoreRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
    getSortedRowModel: getSortedRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    onSortingChange: setSorting,
    onColumnFiltersChange: setColumnFilters,
    onRowSelectionChange: setRowSelection,
    state: {
      sorting,
      columnFilters,
      rowSelection,
    },
  });

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (error) {
    console.error(error);
    return <div>Error loading vulnerability intelligence data</div>;
  }

  return (
    <PageContainer>
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-4">
          <h1 className="text-2xl font-semibold">Vulnerability Intelligence</h1>
          <Input
            placeholder="Filter by vulnerability ID..."
            value={(table.getColumn("vulnerabilityID")?.getFilterValue() as string) ?? ""}
            onChange={(event) =>
              table.getColumn("vulnerabilityID")?.setFilterValue(event.target.value)
            }
            className="max-w-sm"
          />
        </div>
        <div className="flex items-center gap-2">
          {Object.keys(rowSelection).length > 0 && (
            <Button variant="destructive" onClick={() => setShowBulkDeleteDialog(true)}>
              Delete Selected ({Object.keys(rowSelection).length})
            </Button>
          )}
          <Link href="/dashboard/vulnerability-intelligence/new">
            <Button>Add New Entry</Button>
          </Link>
        </div>
      </div>

      {tableStyle.renderTable(table)}
      {tableStyle.Pagination({ table })}
      {tableStyle.BulkDeleteDialog()}
    </PageContainer>
  );
}
